# 预订服务后端技术实现细节与决策理由

## 1. 技术栈选择

### 1.1 Spring Boot 3.x

**选择理由**：

* 最新的Spring Boot版本，提供更好的性能和安全性

* 支持Java 17+的新特性

* 与Spring Cloud 2023.0.4完美兼容

**实现细节**：

* 使用`spring-boot-starter-parent` 3.2.10作为父项目

* 配置Java 17作为编译版本

* 集成Spring Cloud 2023.0.4相关组件

### 1.2 MyBatis-Plus

**选择理由**：

* 简化ORM操作，减少样板代码

* 提供丰富的CRUD操作和查询构建器

* 支持批量操作和性能优化

**实现细节**：

* 使用`mybatis-plus-spring-boot3-starter` 3.5.6确保与Spring Boot 3.x兼容

* 配置`MapperScan`扫描DAO接口

* 实现实体类与数据库表的映射

### 1.3 Redis与Redisson

**选择理由**：

* Redis用于缓存和分布式锁

* Redisson提供更高级的分布式锁实现

* 支持分布式ID生成的Worker ID管理

**实现细节**：

* 配置Redis连接（主机：localhost，端口：6379）

* 使用Redisson实现分布式锁

* 基于Redis的Worker ID分配机制

### 1.4 Nacos服务发现

**选择理由**：

* 提供服务注册与发现功能

* 支持配置中心

* 与Spring Cloud集成良好

**实现细节**：

* 配置Nacos服务地址（localhost:8848）

* 启用服务注册与发现

* 配置服务分组和命名空间

### 1.5 MySQL数据库

**选择理由**：

* 成熟稳定的关系型数据库

* 良好的事务支持

* 适合存储结构化的预订和订单数据

**实现细节**：

* 使用MySQL 8.0

* 配置连接池参数

* 设计合理的数据库表结构

## 2. 架构设计

### 2.1 微服务架构

**设计理由**：

* 模块化设计，便于维护和扩展

* 服务独立部署，提高系统可靠性

* 支持服务水平扩展

**实现细节**：

* 独立的预订服务模块

* 与其他服务通过RESTful API通信

* 集成Nacos服务发现

### 2.2 分层架构

**设计理由**：

* 职责分明，易于测试和维护

* 便于代码复用

* 支持横切关注点

**实现细节**：

* Controller层：处理HTTP请求和响应

* Service层：实现业务逻辑

* DAO层：数据访问操作

* Entity层：数据模型

* Utils层：工具类

### 2.3 分布式锁设计

**设计理由**：

* 防止并发操作导致的数据不一致

* 确保订单创建的原子性

* 提高系统可靠性

**实现细节**：

* 使用Redisson实现分布式锁

* 锁的粒度控制（基于用户ID和资源ID）

* 锁的超时处理和重试机制

### 2.4 分布式ID生成

**设计理由**：

* 确保全局唯一ID

* 支持高并发场景

* 有序ID便于索引和查询

**实现细节**：

* 基于Snowflake算法实现

* 使用Redis分配Worker ID

* 支持多实例部署

## 3. 核心功能实现

### 3.1 预订管理

**实现细节**：

* 支持多种预订类型（航班、酒店、门票）

* 预订状态流转（pending → confirmed → completed → cancelled）

* 支付状态管理（unpaid → paid）

* 与订单系统的集成

**关键API**：

* `POST /booking/create` - 创建预订

* `GET /booking/user/{userId}` - 获取用户预订列表

* `GET /booking/{id}` - 获取预订详情

* `DELETE /booking/{id}/cancel` - 取消预订

### 3.2 订单管理

**实现细节**：

* 订单创建与状态管理

* 订单号生成策略（时间戳+随机数）

* 与支付系统的集成

* 订单查询和统计

**关键API**：

* `POST /booking/order` - 创建订单

* `GET /booking/order/user/{userId}` - 获取用户订单列表

* `GET /booking/order/{id}` - 获取订单详情

### 3.3 支付回调处理

**实现细节**：

* 安全的支付回调接口

* 订单状态更新

* 预订状态同步

* 异常处理和幂等性保证

**关键API**：

* `POST /booking/callback/pay` - 支付回调

### 3.4 搜索功能

**实现细节**：

* 航班搜索

* 酒店搜索

* 门票搜索

* 搜索结果排序和过滤

**关键API**：

* `GET /booking/search/flights` - 航班搜索

* `GET /booking/search/hotels` - 酒店搜索

* `GET /booking/search/tickets` - 门票搜索

## 4. 数据库设计

### 4.1 表结构设计

**设计理由**：

* 支持多种预订类型

* 便于查询和统计

* 减少数据冗余

**实现细节**：

* `booking`表：核心预订信息

* `orders`表：订单信息（避免MySQL关键字冲突）

* `flight_booking`表：航班预订详情

* `hotel_booking`表：酒店预订详情

* `ticket_booking`表：门票预订详情

### 4.2 索引设计

**设计理由**：

* 提高查询性能

* 支持常见的查询场景

**实现细节**：

* 用户ID索引（用于查询用户预订）

* 订单号唯一索引

* 状态字段索引

* 时间字段索引

### 4.3 事务管理

**设计理由**：

* 确保数据一致性

* 支持复杂的业务操作

**实现细节**：

* 使用Spring声明式事务

* 合理的事务边界

* 异常处理和回滚机制

## 5. 安全性设计

### 5.1 API安全

**设计理由**：

* 防止未授权访问

* 保护敏感数据

**实现细节**：

* 基于Spring Security的认证授权

* 测试账号配置（root/123456）

* 接口访问控制

### 5.2 输入验证

**设计理由**：

* 防止恶意输入

* 确保数据合法性

**实现细节**：

* 使用Bean Validation

* 自定义验证规则

* 错误信息处理

### 5.3 支付安全

**设计理由**：

* 确保支付过程安全

* 防止支付欺诈

**实现细节**：

* 安全的支付回调接口

* 签名验证

* 支付状态校验

## 6. 性能优化

### 6.1 缓存策略

**优化理由**：

* 减少数据库访问

* 提高响应速度

**实现细节**：

* Redis缓存热点数据

* 合理的缓存过期时间

* 缓存更新策略

### 6.2 批量操作

**优化理由**：

* 减少数据库连接数

* 提高操作效率

**实现细节**：

* 使用MyBatis-Plus的批量操作

* 合理的批量大小

* 异步处理大批量操作

### 6.3 异步处理

**优化理由**：

* 提高系统响应速度

* 支持高并发

**实现细节**：

* 使用Spring的`@Async`注解

* 合理的线程池配置

* 异步任务监控

### 6.4 数据库优化

**优化理由**：

* 提高查询性能

* 减少数据库负载

**实现细节**：

* 合理的索引设计

* 避免全表扫描

* 分页查询优化

## 7. 关键技术难点与解决方案

### 7.1 Spring Boot 3.x兼容性

**问题**：MyBatis-Plus与Spring Boot 3.x的兼容性问题

**解决方案**：

* 使用`mybatis-plus-spring-boot3-starter`替代`mybatis-plus-boot-starter`

* 更新相关依赖版本

* 调整配置方式

### 7.2 MySQL关键字冲突

**问题**：`order`是MySQL保留关键字

**解决方案**：

* 将表名改为`orders`

* 在实体类中使用`@TableName("orders")`注解

* 确保所有SQL语句使用正确的表名

### 7.3 分布式锁实现

**问题**：高并发场景下的订单重复创建

**解决方案**：

* 使用Redisson实现分布式锁

* 合理的锁粒度设计

* 锁超时和重试机制

### 7.4 分布式ID生成

**问题**：确保全局唯一ID

**解决方案**：

* 基于Snowflake算法实现

* 使用Redis分配Worker ID

* 处理时钟回拨问题

### 7.5 支付回调处理

**问题**：支付回调的安全性和可靠性

**解决方案**：

* 安全的回调接口设计

* 幂等性处理

* 异常捕获和重试机制

## 8. 测试策略

### 8.1 单元测试

**实现细节**：

* 使用JUnit 5进行单元测试

* 测试核心业务逻辑

* 模拟依赖组件

### 8.2 集成测试

**实现细节**：

* 测试服务间集成

* 数据库操作测试

* API接口测试

### 8.3 性能测试

**实现细节**：

* 模拟高并发场景

* 测试系统响应时间

* 数据库性能测试

## 9. 部署与监控

### 9.1 部署策略

**实现细节**：

* Maven构建和打包

* 服务启动脚本

* 环境配置管理

### 9.2 监控方案

**实现细节**：

* 集成Spring Boot Actuator

* 健康检查端点

* 日志管理

## 10. 总结与经验教训

### 10.1 成功经验

* 选择合适的技术栈和版本

* 合理的架构设计

* 充分的测试和验证

* 良好的代码组织和命名规范

### 10.2 改进空间

* 更完善的异常处理

* 更详细的API文档

* 更全面的测试覆盖

* 更精细的性能优化

### 10.3 未来规划

* 支持更多预订类型

* 增强搜索功能

* 集成更多支付方式

* 提供更多数据分析和报表功能

## 11. 技术亮点

1. **Spring Boot 3.x兼容**：解决了MyBatis-Plus与Spring Boot 3.x的兼容性问题
2. **分布式锁实现**：使用Redisson实现高可靠的分布式锁
3. **分布式ID生成**：基于Snowflake算法和Redis的Worker ID分配
4. **多类型预订支持**：统一的预订管理系统，支持多种预订类型
5. **高并发处理**：优化的系统设计，支持高并发场景
6. **完整的API设计**：标准化的RESTful API，详细的接口文档
7. **安全性考虑**：多层次的安全防护措施
8. **可扩展性设计**：模块化架构，易于扩展和维护

***

本文档记录了预订服务后端开发过程中的关键技术决策和实现细节，为后续的维护和扩展提供参考。
