# 用户认证系统设计与开发方案

## 1. 方案概述

基于开源项目 Sa-Token，设计一个完整的用户认证系统，支持微信账号注册和手机号注册，结合 MySQL、Redis、RabbitMQ 进行开发，实现安全、高效的用户认证功能。

## 2. 技术选型

- **认证框架**：Sa-Token 1.44.0（提供登录认证、权限管理、会话管理等功能）
- **数据存储**：MySQL 8.0（用户信息持久化）
- **缓存系统**：Redis 7.0（会话管理、验证码存储、分布式锁）
- **消息队列**：RabbitMQ 3.12.10（异步处理短信发送）
- **ORM框架**：MyBatis-Plus 3.5.6（数据库操作）
- **安全加密**：BCrypt（密码加密）

## 3. 数据库设计

### 3.1 用户表（user）

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| id | BIGINT | 用户ID（主键） |
| phone | VARCHAR(20) | 手机号 |
| password | VARCHAR(255) | 密码（BCrypt加密） |
| nickname | VARCHAR(50) | 昵称 |
| avatar | VARCHAR(255) | 头像 |
| gender | TINYINT | 性别（0-未知，1-男，2-女） |
| birthday | DATETIME | 生日 |
| email | VARCHAR(100) | 邮箱 |
| city | VARCHAR(50) | 城市 |
| bio | VARCHAR(500) | 个人简介 |
| type | TINYINT | 用户类型（0-普通用户，1-旅行达人，2-商家） |
| status | TINYINT | 状态（0-禁用，1-启用） |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |
| deleted | TINYINT | 逻辑删除（0-未删除，1-已删除） |

### 3.2 第三方账号关联表（user_third_party）

| 字段名 | 数据类型 | 描述 |
|-------|---------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（外键） |
| third_type | VARCHAR(20) | 第三方类型（wechat） |
| third_openid | VARCHAR(100) | 第三方OpenID |
| third_unionid | VARCHAR(100) | 第三方UnionID |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

## 4. 功能设计

### 4.1 手机号注册

1. **发送验证码**：
   - 验证手机号格式
   - 使用 Redis 分布式锁避免短信重发
   - 生成 6 位验证码
   - 存储验证码到 Redis（5分钟过期）
   - 通过 RabbitMQ 异步发送短信

2. **注册流程**：
   - 验证手机号和验证码
   - 检查手机号是否已注册
   - 密码加密存储
   - 创建用户信息
   - 自动登录并返回 token

### 4.2 微信注册

1. **微信授权**：
   - 获取微信 code
   - 调用微信 API 获取 openid 和 unionid
   - 检查是否已绑定用户

2. **注册流程**：
   - 如果未绑定，创建新用户
   - 绑定微信账号
   - 自动登录并返回 token

### 4.3 登录认证

1. **手机号登录**：
   - 支持密码登录和验证码登录
   - 密码验证
   - 验证码验证
   - Sa-Token 登录认证
   - 生成 token 并返回

2. **微信登录**：
   - 微信授权获取 openid
   - 检查微信账号是否绑定
   - Sa-Token 登录认证
   - 生成 token 并返回

### 4.4 会话管理

- **Token 管理**：使用 Sa-Token 生成和管理 token
- **会话存储**：Redis 存储会话信息
- **登出**：支持主动登出和 token 过期
- **踢人下线**：支持管理员踢人下线

### 4.5 密码管理

- **密码修改**：验证原密码后修改
- **密码重置**：通过手机号验证码重置

## 5. 代码开发计划

### 5.1 依赖配置

在 `pom.xml` 中添加 Sa-Token 依赖：

```xml
<!-- Sa-Token 权限认证 -->
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-spring-boot-starter</artifactId>
    <version>1.44.0</version>
</dependency>
```

### 5.2 核心代码开发

1. **配置类**：
   - Sa-Token 配置
   - Redis 配置
   - RabbitMQ 配置

2. **工具类**：
   - 短信发送工具
   - 微信授权工具
   - 密码加密工具

3. **Service 层**：
   - UserService：用户管理
   - AuthService：认证管理
   - SmsService：短信服务
   - WechatService：微信服务

4. **Controller 层**：
   - AuthController：认证相关接口
   - UserController：用户相关接口

5. **消息队列**：
   - SmsConsumer：短信消费者

6. **数据访问**：
   - UserMapper：用户数据访问
   - UserThirdPartyMapper：第三方账号关联数据访问

## 6. 关键技术实现

### 6.1 基于 Sa-Token 的登录认证

- 使用 `StpUtil.login()` 进行登录认证
- 使用 `@SaCheckLogin` 注解进行接口权限控制
- 使用 Redis 存储会话信息

### 6.2 基于 Redis + RabbitMQ 的短信发送

- 使用 Redis 分布式锁避免短信重发
- 使用 RabbitMQ 异步发送短信，提高系统响应速度

### 6.3 基于 BCrypt 的密码加密

- 使用 BCrypt 对密码进行加密存储
- 验证密码时使用 BCrypt 进行匹配

### 6.4 基于 Redis 的验证码管理

- 生成验证码并存储到 Redis
- 设置验证码过期时间（5分钟）
- 验证时从 Redis 获取并校验

### 6.5 基于 MySQL + Redis 的用户信息管理

- MySQL 存储用户持久化信息
- Redis 缓存热点用户信息，提高访问速度

## 7. 安全性考虑

- **密码加密**：使用 BCrypt 加密存储密码
- **SQL注入防护**：使用 MyBatis-Plus 防止 SQL 注入
- **XSS防护**：对用户输入进行过滤
- **CSRF防护**：使用 Sa-Token 的 CSRF 防护
- **敏感信息保护**：敏感信息不返回前端
- **接口限流**：防止暴力破解和 DoS 攻击

## 8. 测试计划

- **单元测试**：测试核心功能模块
- **集成测试**：测试各模块集成情况
- **压力测试**：测试系统在高并发下的性能
- **安全测试**：测试系统的安全性

## 9. 部署计划

- **开发环境**：本地开发环境
- **测试环境**：测试服务器
- **生产环境**：生产服务器集群

## 10. 预期效果

- **安全可靠**：使用 Sa-Token 提供的安全认证机制，确保用户数据安全
- **高效稳定**：结合 Redis 和 RabbitMQ，提高系统响应速度和稳定性
- **易于扩展**：模块化设计，易于添加新功能
- **用户友好**：支持多种注册和登录方式，提高用户体验

通过以上方案，我们将构建一个安全、高效、完整的用户认证系统，满足项目的需求。