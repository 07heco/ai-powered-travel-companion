# 预订服务后端功能开发计划

## 1. 分支管理
- 创建新分支 `booking-service-dev` 用于开发预订服务功能
- 开发完成后合并到主分支

## 2. 数据库表结构设计

### 2.1 核心表结构

#### 2.1.1 `booking` 表（预订主表）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 预订ID |
| `user_id` | `BIGINT` | `NOT NULL` | 用户ID |
| `trip_id` | `BIGINT` | `NULL` | 关联行程ID |
| `booking_type` | `VARCHAR(50)` | `NOT NULL` | 预订类型（flight/hotel/ticket） |
| `booking_name` | `VARCHAR(255)` | `NOT NULL` | 预订名称 |
| `total_price` | `DECIMAL(10,2)` | `NOT NULL` | 总价格 |
| `status` | `VARCHAR(20)` | `NOT NULL` | 预订状态（pending/confirmed/cancelled） |
| `payment_status` | `VARCHAR(20)` | `NOT NULL` | 支付状态（unpaid/paid/refunded） |
| `check_in_date` | `DATETIME` | `NULL` | 入住/使用开始日期 |
| `check_out_date` | `DATETIME` | `NULL` | 退房/使用结束日期 |
| `adult_count` | `INT` | `NULL` | 成人数量 |
| `child_count` | `INT` | `NULL` | 儿童数量 |
| `created_at` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 2.1.2 `order` 表（订单表）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 订单ID |
| `user_id` | `BIGINT` | `NOT NULL` | 用户ID |
| `booking_id` | `BIGINT` | `NOT NULL` | 关联预订ID |
| `order_no` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 订单号 |
| `total_amount` | `DECIMAL(10,2)` | `NOT NULL` | 总金额 |
| `status` | `VARCHAR(20)` | `NOT NULL` | 订单状态（pending/paid/cancelled） |
| `payment_method` | `VARCHAR(50)` | `NULL` | 支付方式（alipay/wechat/card） |
| `transaction_id` | `VARCHAR(100)` | `NULL` | 交易ID |
| `created_at` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `DATETIME` | `NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

#### 2.1.3 `flight_booking` 表（航班预订详情）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 航班预订ID |
| `booking_id` | `BIGINT` | `NOT NULL UNIQUE` | 关联预订ID |
| `flight_no` | `VARCHAR(20)` | `NOT NULL` | 航班号 |
| `airline` | `VARCHAR(100)` | `NOT NULL` | 航空公司 |
| `departure_airport` | `VARCHAR(100)` | `NOT NULL` | 出发机场 |
| `arrival_airport` | `VARCHAR(100)` | `NOT NULL` | 到达机场 |
| `departure_time` | `DATETIME` | `NOT NULL` | 出发时间 |
| `arrival_time` | `DATETIME` | `NOT NULL` | 到达时间 |
| `class_type` | `VARCHAR(50)` | `NOT NULL` | 舱位类型 |
| `passenger_info` | `JSON` | `NOT NULL` | 乘客信息 |

#### 2.1.4 `hotel_booking` 表（酒店预订详情）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 酒店预订ID |
| `booking_id` | `BIGINT` | `NOT NULL UNIQUE` | 关联预订ID |
| `hotel_name` | `VARCHAR(255)` | `NOT NULL` | 酒店名称 |
| `hotel_address` | `VARCHAR(255)` | `NOT NULL` | 酒店地址 |
| `room_type` | `VARCHAR(100)` | `NOT NULL` | 房型 |
| `room_count` | `INT` | `NOT NULL` | 房间数量 |
| `guest_info` | `JSON` | `NOT NULL` | 客人信息 |

#### 2.1.5 `ticket_booking` 表（门票预订详情）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| `id` | `BIGINT` | `PRIMARY KEY AUTO_INCREMENT` | 门票预订ID |
| `booking_id` | `BIGINT` | `NOT NULL UNIQUE` | 关联预订ID |
| `attraction_name` | `VARCHAR(255)` | `NOT NULL` | 景点名称 |
| `ticket_type` | `VARCHAR(100)` | `NOT NULL` | 门票类型 |
| `ticket_count` | `INT` | `NOT NULL` | 门票数量 |
| `visit_date` | `DATE` | `NOT NULL` | 游玩日期 |
| `visitor_info` | `JSON` | `NOT NULL` | 游客信息 |

## 3. 核心功能实现

### 3.1 数据模型实现
- 实现所有实体类，使用 MyBatis-Plus 注解配置
- 创建数据库表结构初始化脚本

### 3.2 服务层实现
- 实现 `BookingServiceImpl` 类，提供完整的预订管理功能
- 实现 `OrderServiceImpl` 类，提供订单管理功能
- 实现 `FlightSearchService`、`HotelSearchService`、`TicketSearchService` 搜索服务
- 集成 Redis 缓存，提升查询性能

### 3.3 接口实现
- 实现 `/api/v1/booking/callback/pay` 支付回调接口
- 实现航班搜索和预订接口
- 实现酒店搜索和预订接口
- 实现门票搜索和预订接口
- 完善预订管理相关接口
- 完善订单管理相关接口

## 4. 搜索功能优化

### 4.1 搜索性能优化
- 基于 ElasticSearch 实现高效搜索
- 基于 Redis + Caffeine 多级缓存，提升搜索效率
- 基于 ElasticSearch 的 search_after 解决深分页问题

### 4.2 搜索功能增强
- 实现多条件组合搜索
- 实现排序和筛选功能
- 实现搜索结果的缓存

## 5. 高并发处理方案

### 5.1 唯一订单号生成
- 基于雪花算法+Redis 自增 ID 实现唯一订单号生成
- 确保分布式环境下的订单号唯一性

### 5.2 并发控制
- 基于 Redis 分布式锁解决高并发情况下的订单重复问题
- 基于状态机+乐观锁解决订单支付和关单的并发问题
- 基于 Token 校验避免订单重复提交

### 5.3 性能优化
- 基于 Redis+MQ+数据库实现高并发扣减
- 基于 JetCache 多级缓存实现用户信息快速查询
- 基于 CompletionService 编排并发消费任务，提升处理速度

## 6. 可靠性保障

### 6.1 幂等性控制
- 基于幂等控制避免消息的重复消费
- 基于一锁二判三更新实现支付幂等

### 6.2 数据一致性
- 基于延迟双删的方案保证数据一致性
- 基于 RocketMQ 的批量消费减低消息堆积和延迟问题

### 6.3 定时任务
- 基于 XXL-JOB 定时任务实现支付单到期关闭
- 基于主动+被动组合方式实现订单的关闭

## 7. 测试和优化

### 7.1 单元测试
- 为核心服务方法编写单元测试
- 确保服务的正确性和稳定性

### 7.2 集成测试
- 测试服务间的集成调用
- 测试支付回调流程
- 测试搜索和预订的完整流程

### 7.3 性能测试
- 模拟高并发场景，测试系统的稳定性和性能
- 优化系统参数和代码结构

## 8. 技术栈
- Spring Boot 3.x
- Spring Cloud Alibaba
- MyBatis-Plus
- Redis + Redisson
- MySQL
- RocketMQ
- XXL-JOB
- ElasticSearch (可选)
- Knife4j (API 文档)

## 9. 预期成果
- 完整的预订服务后端功能，包括航班、酒店、门票的搜索和预订
- 高并发场景下的稳定运行
- 完善的 API 文档
- 可扩展的代码结构
- 优化的搜索性能